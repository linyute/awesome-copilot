---
description: 'Azure 現代 Terraform 程式碼產生指引'
applyTo: '**/*.tf'
---

## 1. 使用最新 Terraform 與 Provider
一律以最新穩定版的 Terraform 及 Azure provider 為目標。在程式碼中指定所需的 Terraform 與 provider 版本以強制執行。持續更新 provider 版本以獲得新功能與修正。

## 2. 程式碼結構清晰
以邏輯檔案分隔方式組織 Terraform 設定：

- `main.tf` 放資源
- `variables.tf` 放輸入參數
- `outputs.tf` 放輸出
- 命名慣例與格式統一（建議用 `terraform fmt`）

這樣程式碼易於瀏覽與維護。

## 3. 模組封裝

使用 Terraform 模組將可重複使用的基礎架構元件分組。若某資源組會在多處使用：

- 建立獨立模組，含自己的變數與輸出
- 以引用方式使用，避免重複程式碼
- 促進重用與一致性

## 4. 善用變數與輸出

- **所有可設定值皆參數化**，使用具型別與說明的變數
- **選用變數提供預設值**
- **用輸出公開重要資源屬性**，供其他模組或使用者參考
- **敏感值請標記**，保護機密資料

## 5. Provider 選擇（AzureRM vs AzAPI）

- **大多數情境用 `azurerm` provider**，穩定且涵蓋多數 Azure 服務
- **僅在需要最新 Azure 功能或 `azurerm` 尚未支援的資源時用 `azapi` provider**
- **在程式碼註解中說明選擇原因**
- 兩者可同時使用，但不確定時優先選擇 `azurerm`

## 6. 最小化相依性

- **勿引入專案範疇外的 provider 或模組，除非經確認**
- 若需特殊 provider（如 `random`、`tls`）或外部模組：
  - 加註註解說明
  - 確保使用者同意
- 保持基礎架構堆疊精簡，避免不必要複雜度

## 7. 確保冪等性

- 設定檔可重複套用且結果一致
- **避免非冪等行為**：
  - 每次套用都執行的腳本
  - 重複建立可能衝突的資源
- **多次執行 `terraform apply` 測試**，第二次執行應無變更
- 用資源生命週期設定或條件運算式妥善處理漂移或外部變更

## 8. 狀態管理

- **使用遠端後端**（如 Azure Storage 並啟用狀態鎖定）安全儲存 Terraform 狀態
- 支援團隊協作
- **絕不將狀態檔提交至版本控制**
- 可避免衝突並維持基礎架構狀態一致

## 9. 文件與原理圖

- **維持最新文件**
- **每次程式碼變更都要更新 README.md**，包含新變數、輸出或使用說明
- 可用 `terraform-docs` 等工具自動化
- **每次重大更新後同步更新架構原理圖**
- 文件與原理圖完善，團隊皆能理解基礎架構

## 10. 驗證與測試變更

- **執行 `terraform validate`**，並檢查 `terraform plan` 輸出再套用變更
- 及早發現錯誤或非預期修改
- **建議實作自動化檢查**：
  - CI 流程
  - pre-commit hook
  - 強制格式化、lint 與基本驗證
