---
description: '規格驅動工作流程 v1 提供結構化軟體開發方法，確保需求明確、設計周全、實作完整記錄與驗證。'
applyTo: '**'
---
# 規格驅動工作流程 v1

**規格驅動工作流程：**
銜接需求與實作之間的落差。

**請隨時維護以下文件：**

- **`requirements.md`**：以 EARS 標記法撰寫的使用者故事與驗收標準。
- **`design.md`**：技術架構、序列圖、實作考量。
- **`tasks.md`**：詳細且可追蹤的實作計畫。

## 通用文件架構

**文件規則：**
詳細模板為所有文件的**唯一事實依據**。

**摘要格式：**
僅用於 changelog 或 pull request 描述等簡要文件。

### 詳細文件模板

#### 行動文件模板（所有步驟/執行/測試）

```bash
### [TYPE] - [ACTION] - [TIMESTAMP]
**目標**: [執行目標]
**背景**: [現況、需求與前置步驟參照]
**決策**: [所選方法與理由，若有 Decision Record 請註明]
**執行**: [執行步驟、參數與指令。程式碼請註明檔案路徑。]
**輸出**: [完整結果、日誌、指令輸出與指標]
**驗證**: [成功驗證方式與結果。若失敗請附補救計畫。]
**下一步**: [自動銜接至下一具體行動]
```

#### 決策記錄模板（所有決策）

```bash
### Decision - [TIMESTAMP]
**決策**: [決定內容]
**背景**: [需決策情境與依據資料]
**選項**: [評估過的替代方案及簡要優缺點]
**理由**: [為何選擇此方案，並明確說明權衡]
**影響**: [對實作、維護性與效能的預期影響]
**檢討**: [重新評估條件或時程]
```

### 摘要格式（報告用）

#### 精簡行動日誌

用於產生簡要 changelog。每則日誌皆源自完整行動文件。

`[TYPE][TIMESTAMP] 目標: [X] → 行動: [Y] → 結果: [Z] → 下一步: [W]`

#### 精簡決策記錄

用於 pull request 摘要或主管報告。

`決策: [X] | 理由: [Y] | 影響: [Z] | 檢討: [日期]`

## 執行流程（六階段循環）

**不可跳過任何步驟。用詞一致，降低歧義。**

### **階段 1：分析（ANALYZE）**

**目標：**

- 了解問題。
- 分析現有系統。
- 產出明確且可測試的需求。
- 思考可能解法及其影響。

**檢查表：**

- [ ] 閱讀所有程式碼、文件、測試與日誌。
      - 文件化檔案清單、摘要與初步分析。
- [ ] 以 **EARS 標記法**定義需求：
      - 將功能需求轉為結構化、可測試的需求。
      - 格式：`WHEN [條件或事件]，THE SYSTEM SHALL [預期行為]`
- [ ] 識別相依與限制。
      - 文件化相依圖、風險與因應策略。
- [ ] 繪製資料流與互動。
      - 文件化系統互動圖與資料模型。
- [ ] 整理邊界情境與失敗案例。
      - 文件化完整邊界情境矩陣與潛在失敗點。
- [ ] 評估信心。
      - 產生**信心分數（0-100%）**，依需求明確度、複雜度與問題範疇。
      - 文件化分數與理由。

**重要限制：**

- **需求未明確且文件化前不可進入下一步。**

### **階段 2：設計（DESIGN）**

**目標：**

- 建立完整技術設計與詳細實作計畫。

**檢查表：**

- [ ] **依信心分數調整執行策略：**
  - **高信心（>85%）**
    - 擬定完整逐步實作計畫。
    - 跳過 PoC 步驟。
    - 直接進行全自動化實作。
    - 維持標準完整文件。
  - **中信心（66–85%）**
    - 優先 PoC 或 MVP。
    - 明確定義 PoC/MVP 成功標準。
    - 先建 PoC/MVP，再逐步擴充計畫。
    - 文件化 PoC/MVP 目標、執行與驗證結果。
  - **低信心（<66%）**
    - 首階段專注研究與知識建立。
    - 用語意搜尋分析類似實作。
    - 整理研究文件。
    - 研究後重跑分析階段。
    - 若信心仍低則升級處理。

- [ ] **於 `design.md` 文件化技術設計：**
  - **架構**：元件與互動高階概述。
  - **資料流**：圖示與說明。
  - **介面**：API 合約、schema、公開函式簽名。
  - **資料模型**：資料結構與資料庫 schema。

- [ ] **文件化錯誤處理：**
  - 建立錯誤矩陣，說明處理流程與預期回應。

- [ ] **定義單元測試策略。**

- [ ] **於 `tasks.md` 建立實作計畫：**
  - 每項任務皆含描述、預期結果與相依。

**重要限制：**

- **設計與計畫未完成且驗證前不可進入實作。**

### **階段 3：實作（IMPLEMENT）**

**目標：**

- 依設計與計畫撰寫生產等級程式碼。

**檢查表：**

- [ ] 小步驟撰寫可測試程式碼。
      - 每步皆文件化程式變更、結果與測試連結。
- [ ] 由相依向上實作。
      - 文件化解決順序、理由與驗證。
- [ ] 遵循慣例。
      - 文件化遵循與偏離處，並加 Decision Record。
- [ ] 加入有意義註解。
      - 聚焦意圖（「為什麼」），非機制（「做什麼」）。
- [ ] 依計畫建立檔案。
      - 文件化檔案建立紀錄。
- [ ] 即時更新任務狀態。

**重要限制：**

- **所有實作步驟未文件化與測試前不可合併或部署。**

### **階段 4：驗證（VALIDATE）**

**目標：**

- 驗證實作是否符合所有需求與品質標準。

**檢查表：**

- [ ] 執行自動化測試。
      - 文件化輸出、日誌與覆蓋率報告。
      - 若失敗，文件化根本原因分析與補救。
- [ ] 必要時執行手動驗證。
      - 文件化流程、檢查表與結果。
- [ ] 測試邊界情境與錯誤。
      - 文件化結果與正確錯誤處理證據。
- [ ] 驗證效能。
      - 文件化指標與關鍵區段分析。
- [ ] 記錄執行追蹤。
      - 文件化路徑分析與執行時行為。

**重要限制：**

- **所有驗證步驟未完成且所有問題未解決前不可進入下一步。**

### **階段 5：反思（REFLECT）**

**目標：**

- 改善程式碼庫、更新文件並分析效能。

**檢查表：**

- [ ] 為可維護性重構。
      - 文件化決策、前後比較與影響。
- [ ] 更新所有專案文件。
      - 確保所有 README、圖示與註解皆最新。
- [ ] 識別潛在改善。
      - 文件化待辦清單並排序。
- [ ] 驗證成功標準。
      - 文件化最終驗證矩陣。
- [ ] 進行後設分析。
      - 反思效率、工具使用與流程遵循。
- [ ] 自動建立技術債議題。
      - 文件化清單與補救計畫。

**重要限制：**

- **所有文件與改善行動未記錄前不可結束此階段。**

### **階段 6：交付（HANDOFF）**

**目標：**

- 封裝成果供審查與部署，並銜接至下一任務。

**檢查表：**

- [ ] 產生主管摘要。
      - 用**精簡決策記錄**格式。
- [ ] 準備 pull request（如適用）：
    1. 主管摘要。
    2. 精簡行動日誌。
    3. 驗證文件與 Decision Record 連結。
    4. 最終 `requirements.md`、`design.md`、`tasks.md` 連結。
- [ ] 完成工作區。
      - 將中間檔案、日誌與暫存檔歸檔至 `.agent_work/`。
- [ ] 銜接至下一任務。
      - 文件化轉換或完成。

**重要限制：**

- **所有交付步驟未完成且文件化前不可視為任務結束。**

## 疑難排解與重試流程

**遇到錯誤、歧義或阻礙時：**

**檢查表：**

1. **重新分析**：
   - 回到分析階段。
   - 確認所有需求與限制皆明確且完整。
2. **重新設計**：
   - 回到設計階段。
   - 依需要更新技術設計、計畫或相依。
3. **重新規劃**：
   - 調整 `tasks.md` 實作計畫以因應新發現。
4. **重試執行**：
   - 以修正參數或邏輯重新執行失敗步驟。
5. **升級處理**：
   - 若重試後仍有問題，依升級流程處理。

**重要限制：**

- **遇到未解決錯誤或歧義時，絕不可繼續。所有疑難排解步驟與結果皆需文件化。**

## 技術債管理（自動化）

### 識別與文件化

- **程式碼品質**：實作時持續以靜態分析評估品質。
- **權宜措施**：所有以速度優先取代品質的決策皆需明確記錄其影響於 Decision Record。
- **工作區**：監控組織偏移與命名不一致。
- **文件**：追蹤不完整、過時或缺漏文件。

### 自動建立議題模板

```text
**標題**：[技術債] - [簡要說明]
**優先級**：[高/中/低，依商業影響與補救成本]
**位置**：[檔案路徑與行號]
**原因**：[產生技術債原因，若有 Decision Record 請連結]
**影響**：[目前與未來影響（如拖慢開發、增加 bug 風險）]
**補救**：[具體可執行的解決步驟]
**預估工時**：[解決預估（如 T-shirt size: S, M, L）]
```

### 自動化補救（自動排序）

- 依風險排序並分析相依。
- 估算工時以利未來規劃。
- 大型重構建議遷移策略。

## 品質保證（自動化）

### 持續監控

- **靜態分析**：程式風格、品質、安全性漏洞與架構規則皆 lint。
- **動態分析**：於 staging 環境監控執行時行為與效能。
- **文件**：自動檢查文件完整性與正確性（如連結、格式）。

### 品質指標（自動追蹤）

- 程式覆蓋率百分比與缺口分析。
- 每個函式/方法的圈複雜度分數。
- 可維護性指數評估。
- 技術債比率（如預估補救時間/開發時間）。
- 文件覆蓋率百分比（如公開方法皆有註解）。

## EARS 標記法參考

**EARS（Easy Approach to Requirements Syntax）** - 標準需求格式：

- **普遍性**：`THE SYSTEM SHALL [預期行為]`
- **事件驅動**：`WHEN [觸發事件] THE SYSTEM SHALL [預期行為]`
- **狀態驅動**：`WHILE [特定狀態] THE SYSTEM SHALL [預期行為]`
- **非預期行為**：`IF [非預期條件] THEN THE SYSTEM SHALL [必要回應]`
- **選用性**：`WHERE [包含功能] THE SYSTEM SHALL [預期行為]`
- **複合性**：可組合上述模式以描述複雜需求

每項需求必須：

- **可測試**：可用自動化或手動測試驗證
- **明確**：僅有單一解釋
- **必要**：有助於系統目標
- **可行**：可於限制內實作
- **可追溯**：可連結至使用者需求與設計元素
