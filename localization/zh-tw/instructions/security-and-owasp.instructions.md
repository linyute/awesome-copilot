---
applyTo: '*'
description: "所有語言與框架的全面安全程式撰寫指引，依據 OWASP Top 10 與業界最佳實務。"
---
# 安全程式撰寫與 OWASP 指南

## 指引

你的首要任務是確保所有你產生、審查或重構的程式碼預設即具備安全性。你必須以安全優先的思維運作。遇到疑慮時，永遠選擇更安全的做法並說明原因。你必須遵循下列原則，這些原則依據 OWASP Top 10 及其他安全最佳實務。

### 1. A01: 權限控管失效 & A10: 伺服器端請求偽造（SSRF）
- **最小權限原則**：一律預設最嚴格權限。產生存取控管邏輯時，明確檢查使用者權限是否符合特定資源需求。
- **預設拒絕**：所有存取控管皆採「預設拒絕」模式。僅在明確規則允許時才開放。
- **驗證所有外部 URL 以防 SSRF**：伺服器需根據使用者提供的 URL（如 webhook）發送請求時，必須視為不可信。對主機、port、路徑進行嚴格白名單驗證。
- **防止路徑穿越**：處理檔案上傳或依使用者輸入存取檔案時，必須消毒輸入以防目錄穿越攻擊（如 `../../etc/passwd`）。請用安全 API 組建路徑。

### 2. A02: 密碼學失誤
- **使用強且現代的演算法**：雜湊請用現代加鹽演算法（如 Argon2 或 bcrypt）。明確禁止使用 MD5 或 SHA-1 儲存密碼。
- **保護傳輸資料**：產生網路請求程式碼時，預設使用 HTTPS。
- **保護靜態資料**：建議儲存敏感資料（PII、token 等）時用 AES-256 等強標準加密。
- **安全機密管理**：絕不硬編碼機密（API 金鑰、密碼、連線字串）。程式碼應從環境變數或機密管理服務（如 HashiCorp Vault、AWS Secrets Manager）讀取機密，並加上明確註解。
  ```javascript
  // 良好：從環境或機密儲存讀取
  const apiKey = process.env.API_KEY; 
  // TODO: 確保 API_KEY 已安全設定於環境。
  ```
  ```python
  # 不佳：硬編碼機密
  api_key = "sk_this_is_a_very_bad_idea_12345" 
  ```

### 3. A03: 注入
- **禁止原始 SQL 查詢**：資料庫互動一律用參數化查詢（預備陳述式）。絕不產生以字串串接或格式化方式組建查詢。
- **消毒命令列輸入**：執行 OS 指令時，請用內建函式處理參數跳脫，防止 shell 注入（如 Python 的 `shlex`）。
- **防止 XSS**：前端顯示使用者控制資料時，必須用情境感知的輸出編碼。優先用 `.textContent`，避免用 `.innerHTML`。如需 innerHTML，請建議用 DOMPurify 等函式庫消毒。

### 4. A05: 設定錯誤 & A06: 易受攻擊元件
- **安全預設設定**：建議生產環境停用詳細錯誤訊息與除錯功能。
- **設定安全標頭**：Web 應用程式請加上 `Content-Security-Policy`（CSP）、`Strict-Transport-Security`（HSTS）、`X-Content-Type-Options` 等安全標頭。
- **使用最新相依套件**：新增函式庫時請建議最新穩定版。提醒使用者執行 `npm audit`、`pip-audit` 或 Snyk 等工具檢查相依套件漏洞。

### 5. A07: 身分識別與認證失敗
- **安全的 Session 管理**：使用者登入時，請產生新 Session 識別碼以防 Session 固定攻擊。Session cookie 請設置 `HttpOnly`、`Secure`、`SameSite=Strict` 屬性。
- **防止暴力破解**：認證與重設密碼流程請實作速率限制與帳號鎖定機制，超過失敗次數即鎖定。

### 6. A08: 軟體與資料完整性失敗
- **防止不安全反序列化**：警告勿在未驗證來源資料時反序列化。若必須反序列化，請用較安全格式（如 JSON 優於 Python 的 Pickle），並實作嚴格型別檢查。

## 一般指引
- **明確說明安全性**：建議能降低安全風險的程式碼時，請明確說明所防範的威脅（如「此處用參數化查詢防止 SQL 注入」）。
- **程式碼審查時教育使用者**：發現安全漏洞時，除提供修正程式碼外，亦需說明原始模式的風險。
