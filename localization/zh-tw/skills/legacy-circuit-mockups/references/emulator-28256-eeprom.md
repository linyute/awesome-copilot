# AT28C256 EEPROM 模擬規格

## 概述

此文件詳述如何在基於 6502 的系統模擬器中**模擬 AT28C256 (32 KB 平行 EEPROM)**。其目標是實現適用於單板電腦 (SBC)、監視器 (monitors) 與真實 ROM 映像的*行為準確性*，而非僅僅是通用的檔案後端儲存。

AT28C256 常在 6502 系統中用作 **ROM**，但它是*電氣可寫的*，且具備與 SRAM 不同的時序行為。

---

## 晶片摘要

| 參數 | 數值 |
| -------------- | ---------------------- |
| 容量 | 32 KB (256 Kbit) |
| 組織方式 | 32,768 x 8 |
| 位址線 | A0-A14 |
| 資料線 | D0-D7 |
| 電源電壓 | 5V |
| 典型用途 | ROM / 韌體儲存 |

---

## 腳位定義

| 腳位 | 名稱 | 功能 |
| ------ | ------------- | ---------------------- |
| A0-A14 | 位址 | 位元組位址 |
| D0-D7 | 資料 | 資料匯流排 |
| /CE | 晶片致能 (Chip Enable) | 啟動晶片 |
| /OE | 輸出致能 (Output Enable) | 啟用輸出驅動器 |
| /WE | 寫入致能 (Write Enable) | 觸發寫入週期 |
| VCC | +5V | 電源 |
| GND | 接地 | 參考點 |

---

## 讀取週期行為

當符合以下條件時發生讀取：

```
/CE = 0
/OE = 0
/WE = 1
```

### 讀取規則

* 在觸發 `/OE` 之前，位址必須保持穩定
* 資料在存取時間後出現在 D0-D7（在大多數模擬器中會被忽略）
* 當 `/OE = 1` 或 `/CE = 1` 時，輸出為**高阻抗 (high-impedance)**

### 模擬器行為

```text
if CE == 0 and OE == 0 and WE == 1:
    data_bus = memory[address]
else:
    data_bus = Z
```

---

## 寫入週期行為

當符合以下條件時發生寫入：

```
/CE = 0
/WE = 0
```

（在寫入期間 `/OE` 通常為高電位 (HIGH)）

### 重要的 EEPROM 特性

* 寫入**非瞬時完成**
* 每次寫入都會觸發一個**內部程式化週期 (internal programming cycle)**
* 在程式化期間，讀取操作可能會回傳未定義的資料

---

## 寫入時序模型 (簡化版)

### 真實硬體

| 參數 | 典型值 |
| --------------- | -------- |
| 位元組寫入時間 | ~200 µs |
| 分頁大小 | 64 位元組 |
| 分頁寫入時間 | ~10 ms |

### 模擬器簡化選項

#### 選項 A - 瞬時寫入 (最常見)

* 寫入立即更新記憶體
* 無忙碌 (busy) 狀態
* 建議初期模擬器使用

#### 選項 B - 基於週期的忙碌狀態 (進階)

* 追蹤「寫入進行中」的計時器
* 寫入期間的讀取操作回傳最後一個數值或 `0xFF`
* 在週期完成前忽略寫入嘗試

---

## 分頁寫入模擬 (選配)

* 分頁大小：**64 位元組**
* 在逾時前對同一分頁的寫入操作會一起提交
* 跨越分頁邊界會導致分頁內回繞（硬體怪癖）

簡化規則：

```text
page_base = address & 0xFFC0
page_offset = address & 0x003F
```

---

## 寫入保護行為

某些系統在程式化後將 EEPROM 視為**唯讀 (ROM-only)**。

模擬器可支援：

* 唯讀模式（忽略寫入）
* 可程式化模式（允許寫入）
* 執行時切換（模擬程式化跳線）

---

## 電源啟動狀態

* EEPROM 會保留內容
* 啟動電源時無未定義資料

模擬器應：

* 從映像檔載入內容
* 在重設 (resets) 時保留資料

---

## 匯流排爭用規則

| 條件 | 行為 |
| ------------------- | ----------------- |
| /CE = 1 | 資料匯流排 = Z |
| /OE = 1 | 資料匯流排 = Z |
| /WE = 0 且 /OE = 0 | 未定義 (應避免) |

模擬器可以：

* 優先處理寫入
* 或標記無效狀態

---

## 6502 系統中的記憶體映射

常見佈局：

```
$0000-$7FFF  RAM
$8000-$FFFF  AT28C256 EEPROM
```

### 重設向量用法

| 向量 | 位址 |
| ------ | ----------- |
| RESET | $FFFC-$FFFD |
| NMI | $FFFA-$FFFB |
| IRQ | $FFFE-$FFFF |

---

## 模擬器 API 模型

```c
typedef struct {
    uint8_t memory[32768];
    bool write_enabled;
    bool busy;
    uint32_t busy_cycles;
} AT28C256;
```

### 讀取

```c
uint8_t eeprom_read(addr);
```

### 寫入

```c
void eeprom_write(addr, value);
```

---

## 建議的模擬器預設值

| 功能 | 設定 |
| ------------- | ----------- |
| 寫入延遲 | 已停用 |
| 分頁模式 | 已停用 |
| 寫入保護 | 已啟用 |
| 持久性 | 以檔案為後端 |

---

## 測試檢查清單

* 重設向量擷取
* 正常執行下的 ROM 讀取
* 唯讀模式下忽略寫入
* 正確的位址遮罩 (15 位元)
* 停用時不驅動匯流排

---

## 參考資料

* [AT28C256 Datasheet (Microchip)](https://ww1.microchip.com/downloads/aemDocuments/documents/MPD/ProductDocuments/DataSheets/AT28C256-Industrial-Grade-256-Kbit-Paged-Parallel-EEPROM-Data-Sheet-DS20006386.pdf)
* [Ben Eater 6502 電腦系列](https://eater.net/6502)
  * <https://www.youtube.com/watch?v=oO8_2JJV0B4>
* [6502.org 記憶體映射註記](https://6502.co.uk/lesson/memory-map)

---

## 備註

此規格刻意反映**真實硬體的怪癖**，同時允許模擬器作者在簡單性與準確性之間做出選擇。它適用於：

* 教學用模擬器
* SBC 模擬
* ROM 與監視器開發工作流
* 與 6502 + 6522 + SRAM 模擬整合
