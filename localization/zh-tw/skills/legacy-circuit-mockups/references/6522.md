# MOS Technology 6522 多功能介面配接器 (VIA)

## 1. 概述

**MOS Technology 6522 VIA** 是一款通用的 I/O 控制器，旨在將 6502 系列微處理器與外部週邊設備連接。它於 1970 年代中期推出，提供平行 I/O 埠、計時器、位移暫存器 (shift register) 支援及中斷處理。6522 被廣泛應用於 Commodore PET、VIC-20、Apple II、BBC Micro 以及許多基於 6502 的嵌入式設計系統中。

---

## 2. 一般特性

| 特性 | 描述 |
| -------------- | -------------------------------- |
| 資料寬度 | 8 位元 |
| 定址方式 | 記憶體映射 I/O |
| 暫存器 | 16 個 (4 位元暫存器選擇) |
| I/O 埠 | 兩個 8 位元埠 (Port A, Port B) |
| 計時器 | 兩個 16 位元計時器 |
| 位移暫存器 | 8 位元序列 I/O |
| 中斷 | 可屏蔽，多個來源 |
| 時脈 | 系統時脈 (φ2) |

---

## 3. 腳位功能 (邏輯)

### 3.1 Port A (PA0-PA7)

* 8 位元雙向平行 I/O
* 透過 CA1 / CA2 支援交握 (handshake)

### 3.2 Port B (PB0-PB7)

* 8 位元雙向平行 I/O
* 透過 CB1 / CB2 支援交握
* PB6 與 PB7 可由計時器 1 控制

### 3.3 控制腳位

| 腳位 | 描述 |
| --------- | ------------------------------------- |
| CA1 / CB1 | 具備中斷能力的控制輸入 |
| CA2 / CB2 | 交握 / 脈衝 / 中斷腳位 |
| IRQ | 中斷要求輸出 (低電位有效) |
| RESET | 重設輸入 |

---

## 4. 暫存器映射表

暫存器使用 4 條位址線 (RS0-RS3) 進行選擇。基準位址由系統定義。

| 偏移量 | 暫存器 | 描述 |
| -----: | --------- | ------------------------------------ |
|     $0 | ORB | 輸出暫存器 B |
|     $1 | ORA / IRB | 輸出暫存器 A / 輸入暫存器 B |
|     $2 | DDRB | 資料方向暫存器 B |
|     $3 | DDRA | 資料方向暫存器 A |
|     $4 | T1C-L | 計時器 1 計數器 低位 |
|     $5 | T1C-H | 計時器 1 計數器 高位 |
|     $6 | T1L-L | 計時器 1 閂鎖 低位 |
|     $7 | T1L-H | 計時器 1 閂鎖 高位 |
|     $8 | T2C-L | 計時器 2 計數器 低位 |
|     $9 | T2C-H | 計時器 2 計數器 高位 |
|     $A | SR | 位移暫存器 |
|     $B | ACR | 輔助控制暫存器 |
|     $C | PCR | 週邊控制暫存器 |
|     $D | IFR | 中斷旗標暫存器 |
|     $E | IER | 中斷致能暫存器 |
|     $F | ORA / IRA | 輸出暫存器 A / 輸入暫存器 A |

---

## 5. 資料方向暫存器 (DDRA / DDRB)

每個位元控制其對應埠腳位的方向：

* `0` = 輸入
* `1` = 輸出

```text
DDRB 位元 = 1  PBx 為輸出
DDRB 位元 = 0  PBx 為輸入
```

---

## 6. 計時器

### 6.1 計時器 1 (T1)

* 16 位元遞減計數器
* 可運作於單發 (one-shot) 或自由運行 (free-running) 模式
* 可在逾時時切換 PB7 狀態
* 產生中斷

### 6.2 計時器 2 (T2)

* 16 位元遞減計數器
* 支援 PB6 上的脈衝計數
* 僅限單發操作

---

## 7. 位移暫存器 (SR)

* 8 位元位移暫存器
* 可移入或移出資料
* 時脈來源可透過 ACR 選擇
* 常用於序列通訊或鍵盤掃描

---

## 8. 控制暫存器

### 8.1 輔助控制暫存器 (ACR)

| 位元 | 功能 |
| --: | ---------------------------------- |
|   7 | 計時器 1 控制 (PB7 輸出) |
|   6 | 計時器 1 模式 (自由運行 / 單發) |
|   5 | 計時器 2 控制 |
|   4 | 位移暫存器模式 |
|   3 | 位移暫存器時脈來源 |
|   2 | Port B 閂鎖 |
|   1 | Port A 閂鎖 |
|   0 | 未使用 |

### 8.2 週邊控制暫存器 (PCR)

控制 CA1, CA2, CB1, CB2 的行為：

* 輸入/輸出模式
* 觸發邊緣選擇
* 脈衝或交握模式

---

## 9. 中斷系統

### 9.1 中斷旗標暫存器 (IFR)

| 位元 | 來源 |
| --: | ---------------------------------- |
|   7 | IRQ 狀態 (任何已啟用的中斷) |
|   6 | 計時器 1 |
|   5 | 計時器 2 |
|   4 | CB1 |
|   3 | CB2 |
|   2 | 位移暫存器 |
|   1 | CA1 |
|   0 | CA2 |

### 9.2 中斷致能暫存器 (IER)

* 位元 7 決定設定/清除模式：

  * `1` = 設定位元
  * `0` = 清除位元

```text
寫入 $80 | 遮罩  啟用中斷
寫入 $00 | 遮罩  停用中斷
```

---

## 10. 重設行為

重設 (RESET) 時：

* 所有 DDR 位元被清除 (埠預設為輸入)
* 計時器停止
* 位移暫存器停用
* 中斷停用

---

## 11. 定時註記

* VIA 暫存器的存取與 φ2 同步
* 計時器計數器每 φ2 週期遞減一次
* 讀取/寫入暫存器時，某些操作會產生副作用

---

## 12. 常見案例

* 鍵盤與搖桿介面
* 平行印表機介面
* 計時器與事件計數
* 簡易序列通訊
* 通用 GPIO 擴充

---

## 13. 變體與相關晶片

| 晶片 | 註記 |
| ----- | ----------------------------- |
| 6522 | 原始 NMOS VIA |
| 65C22 | CMOS VIA，速度更快，功耗更低 |
| 6520 | 較早期的 PIA (較簡單) |

---

## 14. 參考資料

* <https://en.wikipedia.org/wiki/MOS_Technology_6522>
* <https://grokipedia.com/page/MOS_Technology_6522>

---
