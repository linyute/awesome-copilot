# 6502 CPU 模擬規格

這是一份技術性的 Markdown 規格，用於**模擬 MOS Technology 6502 CPU 家族**，適用於軟體模擬器、教學工具、測試框架及復古計算專案。

---

## 1. 範圍

此規格描述模擬以下元件的功能需求：

* MOS 6502
* WDC 65C02（已註記之處）

不在此範圍內：

* 週期精確的類比行為
* 物理匯流排爭用
* 未記錄的矽晶缺陷（除非明確實作）

---

## 2. CPU 概述

### 核心特性

| 特性 | 數值 |
| ------------- | ------------- |
| 資料寬度 | 8 位元 |
| 位址寬度 | 16 位元 |
| 位址空間 | 64 KB |
| 位元組順序 | 小端序 (Little-endian) |
| 時脈 | 單相 |

---

## 3. 暫存器

| 暫存器 | 大小 | 描述 |
| -------- | ------ | -------------------------- |
| A | 8 位元 | 累加器 |
| X | 8 位元 | 索引暫存器 |
| Y | 8 位元 | 索引暫存器 |
| SP | 8 位元 | 堆疊指標 (分頁 $01xx) |
| PC | 16 位元 | 程式計數器 |
| P | 8 位元 | 處理器狀態旗標 |

### 狀態旗標 (P)

| 位元 | 名稱 | 意義 |
| --- | ---- | ----------------------------- |
| 7 | N | 負數 (Negative) |
| 6 | V | 溢位 (Overflow) |
| 5 | - | 未使用（在推入堆疊時一律為 1） |
| 4 | B | 中斷 (Break) |
| 3 | D | 十進位 |
| 2 | I | 停用 IRQ |
| 1 | Z | 零 (Zero) |
| 0 | C | 進位 (Carry) |

---

## 4. 記憶體模型

### 定址

* 16 位元位址匯流排 (`$0000-$FFFF`)
* 位元組定址

### 必要的模擬器介面

```text
read(address)  -> byte
write(address, byte)
```

### 堆疊行為

* 堆疊基底：`$0100`
* 推入 (Push)：`write($0100 + SP, value); SP--`
* 彈出 (Pull)：`SP++; value = read($0100 + SP)`

---

## 5. 重設與中斷處理

### 重設序列

1. 設定 `I = 1`
2. 設定 `SP = $FD`
3. 清除 `D`
4. 從 `$FFFC-$FFFD` 載入 `PC`

### 中斷向量

| 中斷 | 向量位址 |
| --------- | -------------- |
| NMI | `$FFFA-$FFFB` |
| RESET | `$FFFC-$FFFD` |
| IRQ/BRK | `$FFFE-$FFFF` |

---

## 6. 指令 擷取-解碼-執行 週期

### 執行迴圈 (概念)

```text
opcode = read(PC++)
decode opcode
fetch operands
execute instruction
update flags
increment cycles
```

---

## 7. 定址模式

| 模式 | 範例 | 註記 |
| ---------------- | ------------- | --------------------- |
| 立即 (Immediate) | `LDA #$10` | 常數 |
| 零頁 (Zero Page) | `LDA $20` | 在 $00FF 處回繞 |
| 絕對 (Absolute) | `LDA $2000` | 完整位址 |
| 索引 (Indexed) | `LDA $2000,X` | 選配的分頁懲罰週期 |
| 間接 (Indirect) | `JMP ($FFFC)` | 分頁回繞錯誤 (bug) |
| 索引間接 | `LDA ($20,X)` | 零頁索引 |
| 間接索引 | `LDA ($20),Y` | 零頁指標 |

---

## 8. 指令集需求

### 類別

* 載入/儲存
* 算術 (ADC, SBC)
* 邏輯 (AND, ORA, EOR)
* 位移與旋轉
* 分支
* 堆疊操作
* 系統控制

### 十進位模式 (NMOS 6502)

* 適用於 `ADC` 與 `SBC`
* 當 `D = 1` 時使用 BCD 算術

---

## 9. 旗標行為規則

| 指令類型 | 受影響的旗標 |
| ---------------- | -------------- |
| 載入 | N, Z |
| ADC/SBC | N, V, Z, C |
| CMP/CPX/CPY | N, Z, C |
| INC/DEC | N, Z |
| 位移 | N, Z, C |

---

## 10. 週期計數

### 週期準確度等級

| 等級 | 描述 |
| -------------------- | -------------------- |
| 功能性 | 僅保證結果正確 |
| 指令準確 | 固定週期計數 |
| 週期準確 | 包含跨分頁懲罰週期 |

### 分頁邊界懲罰

* 執行分支：+1 週期
* 分支跨越分頁：+2 週期
* 索引載入跨越分頁：+1 週期

---

## 11. 已知的硬體怪異行為 (NMOS 6502)

| 怪異行為 | 描述 |
| ---------------- | ------------------------------- |
| JMP 間接跳躍錯誤 | 在分頁邊界處的高位元組回繞 |
| BRK 設定 B 旗標 | 僅在推入堆疊時 |
| 未使用的旗標位元 | 讀取時一律為 1 |

---

## 12. 非法 / 未記錄指令 (選配)

* 許多指令碼執行複合操作
* 行為隨矽晶版本而異
* 應預設停用或顯式啟用

---

## 13. 定時與時脈

* 每個指令在多個時脈週期內執行
* 模擬器可按主機滴答 (tick) 執行指令
* I/O 定時需要週期計數器

---

## 14. 與週邊設備整合

### 記憶體映射 I/O

```text
if address in IO range:
    delegate to device
```

範例：

* 6522 VIA
* UART
* 視訊硬體

---

## 15. 測試與驗證

### 建議的測試 ROM

* Klaus Dormann 6502 功能測試
* 中斷與十進位模式測試

### 驗證檢查清單

* 所有指令皆正確執行
* 旗標符合參考行為
* 向量處理正確
* 堆疊操作正確

---

## 16. 參考連結

* [https://www.masswerk.at/6502/6502_instruction_set.html](https://www.masswerk.at/6502/6502_instruction_set.html)
* [https://www.nesdev.org/wiki/6502](https://www.nesdev.org/wiki/6502)
* [https://github.com/Klaus2m5/6502_65C02_functional_tests](https://github.com/Klaus2m5/6502_65C02_functional_tests)
* [https://en.wikipedia.org/wiki/MOS_Technology_6502](https://en.wikipedia.org/wiki/MOS_Technology_6502)

---

**文件範圍：** 6502 CPU 的軟體模擬
**讀者對象：** 模擬器開發者、復古計算工程師
**狀態：** 穩定的技術參考
