# 6522 VIA (多功能介面配接器) 模擬規格

這是一份技術性的 Markdown 規格，用於**模擬 MOS Technology / WDC 6522 VIA**，適用於 6502 系列模擬器、SBC 模擬器及復古計算軟體環境。

---

## 1. 範圍

此文件定義模擬以下元件所需的功能行為：

* MOS Technology 6522 VIA
* WDC 65C22 VIA（CMOS 變體，已註記之處）

不在此範圍內：

* 類比電氣特性
* 匯流排爭用與傳遞延遲
* 未記錄的矽晶競爭條件 (race conditions)

---

## 2. 晶片概述

### 核心功能

| 功能 | 描述 |
| ---------------- | ------------------------------------ |
| I/O 埠 | 兩個 8 位元雙向埠 (A, B) |
| 計時器 | 兩個可程式化計時器 |
| 位移暫存器 | 8 位元序列位移暫存器 |
| 中斷系統 | 可屏蔽，具優先權 |
| 交握 (Handshaking) | CA1/CA2, CB1/CB2 控制線 |

---

## 3. 外部訊號 (邏輯模型)

| 訊號 | 方向 | 用途 |
| -------- | --------- | ------------------------ |
| PA0-PA7 | I/O | Port A |
| PB0-PB7 | I/O | Port B |
| CA1, CA2 | I/O | 控制線 A |
| CB1, CB2 | I/O | 控制線 B |
| IRQ | 輸出 | 對 CPU 的中斷要求 |
| CS1, CS2 | 輸入 | 晶片選擇 |
| R/W | 輸入 | 讀取 / 寫入 |
| RS0-RS3 | 輸入 | 暫存器選擇 |

---

## 4. 暫存器映射表

暫存器使用 RS3-RS0 進行選擇。

| 位址 | 名稱 | R/W | 描述 |
| ------- | ----------- | --- | -------------------------------- |
| 0 | ORB / IRB | R/W | 輸出/輸入暫存器 B |
| 1 | ORA / IRA | R/W | 輸出/輸入暫存器 A |
| 2 | DDRB | R/W | 資料方向暫存器 B |
| 3 | DDRA | R/W | 資料方向暫存器 A |
| 4 | T1C-L | R | 計時器 1 計數器 低位 |
| 5 | T1C-H | R | 計時器 1 計數器 高位 |
| 6 | T1L-L | W | 計時器 1 閂鎖 低位 |
| 7 | T1L-H | W | 計時器 1 閂鎖 高位 |
| 8 | T2C-L | R | 計時器 2 計數器 低位 |
| 9 | T2C-H | R | 計時器 2 計數器 高位 |
| 10 | SR | R/W | 位移暫存器 |
| 11 | ACR | R/W | 輔助控制暫存器 |
| 12 | PCR | R/W | 週邊控制暫存器 |
| 13 | IFR | R/W | 中斷旗標暫存器 |
| 14 | IER | R/W | 中斷致能暫存器 |
| 15 | ORA (無交握) | R/W | 輸出暫存器 A (無交握) |

---

## 5. 資料方向暫存器 (DDR)

* 位元 = 1  輸出
* 位元 = 0  輸入

```text
output = ORx & DDRx
input  = external & ~DDRx
```

---

## 6. 埠行為 (Port Behavior)

### 讀取

* 針對配置為輸入的位元，回傳輸入腳位狀態
* 針對配置為輸出的位元，回傳輸出閂鎖狀態

### 寫入

* 僅更新輸出閂鎖
* 實際腳位數值取決於 DDR

---

## 7. 計時器

### 計時器 1 (T1)

* 16 位元遞減計數器
* 可產生中斷
* 選配的 PB7 切換

### 計時器 2 (T2)

* 16 位元遞減計數器
* 單發 (One-shot) 或脈衝計數 (CB1)

### 計時器模擬規則

* 每個 CPU 週期遞減一次
* 在適當時機從閂鎖重新載入
* 在發生下溢 (underflow) 時設定中斷旗標

---

## 8. 位移暫存器 (SR)

模式由 ACR 控制：

* 已停用
* 在 CB1 時脈下移入
* 在系統時脈下移出

模擬器需求：

* 8 位元位移
* 正確的位元順序
* 選配的外部時脈處理

---

## 9. 控制暫存器

### 輔助控制暫存器 (ACR)

控制：

* 計時器 1 模式
* 計時器 2 模式
* 位移暫存器模式
* PB7 行為

### 週邊控制暫存器 (PCR)

控制：

* CA1/CB1 觸發邊緣靈敏度
* CA2/CB2 交握 / 脈衝 / 輸出模式

---

## 10. 中斷系統

### 中斷旗標暫存器 (IFR)

| 位元 | 來源 |
| --- | -------------------------- |
| 0 | CA2 |
| 1 | CA1 |
| 2 | 位移暫存器 |
| 3 | CB2 |
| 4 | CB1 |
| 5 | 計時器 2 |
| 6 | 計時器 1 |
| 7 | 任何中斷 (邏輯 OR) |

### 中斷致能暫存器 (IER)

* 位元 7 = 設定/清除模式
* 位元 0-6 啟用個別來源

### IRQ 邏輯

```text
IRQ = (IFR & IER & 0x7F) != 0
```

---

## 11. 交握線

### CA1 / CB1

* 邊緣偵測輸入
* 觸發中斷

### CA2 / CB2

* 輸入或輸出
* 脈衝或交握模式

模擬器必須：

* 追蹤腳位狀態
* 偵測配置的觸發邊緣

---

## 12. 重設行為

重設時：

* DDRx = $00
* ORx = $00
* 計時器停止
* IFR 被清除
* IER 被清除
* IRQ 不具活性

---

## 13. 讀取/寫入副作用

| 暫存器 | 副作用 |
| ----------- | ------------------------ |
| ORA/ORB | 清除交握旗標 |
| 寫入 T1C-H | 載入並啟動計時器 1 |
| 寫入 IFR | 清除寫入的位元 |
| 寫入 IER | 設定或清除啟用狀態 |

---

## 14. 模擬定時等級

| 等級 | 描述 |
| -------------- | ------------------------- |
| 功能性 | 正確的暫存器行為 |
| 基於週期 | 計時器隨 CPU 週期滴答 |
| 週期準確 | 符合真實 VIA 定時 |

---

## 15. 與 6502 模擬器整合

```text
CPU 週期  VIA 滴答  更新計時器  更新 IRQ
```

* VIA 必須與 CPU 同步計時
* CPU 在指令邊界處取樣 IRQ 線

---

## 16. 測試與驗證

### 建議的測試

* VIA 計時器測試 ROM
* 埠讀取/寫入測試
* 中斷優先權測試

### 驗證檢查清單

* 計時器計數正確
* IRQ 正確觸發與清除
* DDR 行為正確
* 副作用已實作

---

## 17. 差異：6522 vs 65C22 (摘要)

| 特性 | 6522 | 65C22 |
| -------------- | ------ | -------- |
| 功耗 | 較高 | 較低 |
| 十進位怪癖 | 無 | 已修正 |
| 計時器準確度 | NMOS | 已改進 |

---

## 18. 參考連結

* [https://www.westerndesigncenter.com/wdc/documentation](https://www.westerndesigncenter.com/wdc/documentation)
* [https://www.princeton.edu/~mae412/HANDOUTS/Datasheets/6522.pdf](https://www.princeton.edu/~mae412/HANDOUTS/Datasheets/6522.pdf)
* [https://www.nesdev.org/wiki/6522](https://www.nesdev.org/wiki/6522)

---

**文件範圍：** 6522 VIA 的軟體模擬
**讀者對象：** 模擬器開發者、SBC 設計者
**狀態：** 穩定的技術參考
