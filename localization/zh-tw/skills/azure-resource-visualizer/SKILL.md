---
name: azure-resource-visualizer
description: 分析 Azure 資源群組並產生詳細的 Mermaid 架構圖，顯示個別資源之間的關係。當使用者要求提供其 Azure 資源的圖表或協助理解資源之間的相互關係時，請使用此技能。
license: 完整條款請參閱 LICENSE.txt
metadata:
  author: Tom Meschter (tom.meschter@microsoft.com)
---

# Azure 資源視覺化工具 - 架構圖產生器

使用者可能會請求協助理解個別資源如何組合在一起，或建立顯示它們之間關係的圖表。您的任務是檢查 Azure 資源群組，瞭解其結構和關係，並產生清楚說明架構的完整 Mermaid 圖表。

## 核心職責

1. **資源群組探索**：未指定時列出可用的資源群組
2. **深度資源分析**：檢查所有資源、其組態和相互依賴關係
3. **關係對應**：識別並記錄資源之間的所有連接
4. **圖表產生**：建立詳細、準確的 Mermaid 圖表
5. **文件建立**：產出帶有嵌入圖表的清楚 Markdown 檔案

## 工作流程

### 步驟 1：資源群組選擇

如果使用者尚未指定資源群組：

1. 使用您的工具查詢可用的資源群組。如果您沒有此工具，請使用 `az`。
2. 提供包含位置的資源群組編號清單
3. 要求使用者依編號或名稱選擇一個
4. 等待使用者回應後再繼續

如果已指定資源群組，請驗證其是否存在並繼續。

### 步驟 2：資源探索與分析

取得資源群組後：

1. 使用 Azure MCP 工具或 `az` **查詢資源群組中的所有資源**。
2. **分析每個資源**類型並擷取：
   - 資源名稱和類型
   - SKU/層級資訊
   - 位置/區域
   - 關鍵組態屬性
   - 網路設定 (VNet、子網路、私用端點)
   - 身分識別與存取 (受控身分、RBAC)
   - 依賴關係和連接

3. 透過識別以下內容來**對應關係**：
   - **網路連接**：VNet 對等互連、子網路分配、NSG 規則、私用端點
   - **資料流**：應用程式 → 資料庫、函式 → 儲存體、API 管理 → 後端
   - **身分識別**：連接到資源的受控身分
   - **組態**：指向 Key Vault 的應用程式設定、連接字串
   - **依賴關係**：父子關係、必要資源

### 步驟 3：圖表建構

使用 `graph TB` (由上而下) 或 `graph LR` (由左而右) 格式建立**詳細的 Mermaid 圖表**：

**圖表結構指南：**

```mermaid
graph TB
    %% 使用子圖將相關資源分組
    subgraph "資源群組：[名稱]"
        subgraph "網路層"
            VNET[虛擬網路<br/>10.0.0.0/16]
            SUBNET1[子網路：web<br/>10.0.1.0/24]
            SUBNET2[子網路：data<br/>10.0.2.0/24]
            NSG[網路安全性群組]
        end
        
        subgraph "運算層"
            APP[App Service<br/>方案：P1v2]
            FUNC[函式應用程式<br/>執行階段：.NET 8]
        end
        
        subgraph "資料層"
            SQL[Azure SQL 資料庫<br/>DTU：S1]
            STORAGE[儲存體帳戶<br/>類型：Standard LRS]
        end
        
        subgraph "安全性與身分識別"
            KV[Key Vault]
            MI[受控身分]
        end
    end
    
    %% 使用描述性標籤定義關係
    APP -->|"HTTPS 請求"| FUNC
    FUNC -->|"SQL 連接"| SQL
    FUNC -->|"Blob/佇列存取"| STORAGE
    APP -->|"使用身分識別"| MI
    MI -->|"存取祕密"| KV
    VNET --> SUBNET1
    VNET --> SUBNET2
    SUBNET1 --> APP
    SUBNET2 --> SQL
    NSG -->|"規則套用於"| SUBNET1
```

**關鍵圖表要求：**

- **按層級或目的分組**：網路、運算、資料、安全性、監視
- **包含詳細資訊**：在節點標籤中包含 SKU、層級、重要設定 (使用 `<br/>` 換行)
- **標記所有連接**：描述資源之間流動的內容 (資料、身分識別、網路)
- **使用有意義的節點 ID**：合理的縮寫 (APP、FUNC、SQL、KV)
- **視覺階層**：用於邏輯分組的子圖
- **連接類型**：
  - `-->` 用於資料流或依賴關係
  - `-.->` 用於選用/條件式連接
  - `==>` 用於關鍵/主要路徑

**資源類型範例：**
- App Service：包含方案層級 (B1、S1、P1v2)
- 函式：包含執行階段 (.NET、Python、Node)
- 資料庫：包含層級 (基本、標準、進階)
- 儲存體：包含備援 (LRS、GRS、ZRS)
- VNet：包含位址空間
- 子網路：包含位址範圍

### 步驟 4：檔案建立

使用 [template-architecture.md](./assets/template-architecture.md) 作為範本，建立名為 `[資源群組名稱]-architecture.md` 的 Markdown 檔案，其中包含：

1. **標頭**：資源群組名稱、訂閱、區域
2. **摘要**：架構的簡要概述 (2-3 段)
3. **資源清單**：列出所有資源及其類型和關鍵屬性的表格
4. **架構圖**：完整的 Mermaid 圖表
5. **關係詳情**：關鍵連接和資料流的說明
6. **備註**：任何重要的觀察結果、潛在問題或建議

## 執行準則

### 品質標準

- **準確性**：在納入圖表前驗證所有資源詳情
- **完整性**：不要遺漏資源；包含資源群組中的所有內容
- **清晰度**：使用清楚、具描述性的標籤和邏輯分組
- **詳細程度**：包含對理解架構至關重要的組態詳情
- **關係**：顯示所有重要的連接，而不僅僅是明顯的連接

### 工具使用模式

1. **Azure MCP 搜尋**：
   - 使用 `intent="list resource groups"` 來探索資源群組
   - 對資源群組名稱使用 `intent="list resources in group"` 以取得所有資源
   - 使用 `intent="get resource details"` 進行個別資源分析
   - 當您需要特定的 Azure 操作時，請使用 `command` 參數

2. **檔案建立**：
   - 始終在工作區根目錄或 `docs/` 資料夾 (如果存在) 中建立
   - 使用清楚、具描述性的檔案名稱：`[rg-名稱]-architecture.md`
   - 確保 Mermaid 語法正確 (在輸出前先在腦中測試語法)

3. **終端機 (必要時)**：
   - 使用 Azure CLI 進行 MCP 無法提供的複雜查詢
   - 範例：`az resource list --resource-group <名稱> --output json`
   - 範例：`az network vnet show --resource-group <名稱> --name <vnet-名稱>`

### 約束與界限

**務必執行：**
- ✅ 未指定時列出資源群組
- ✅ 等待使用者選擇後再繼續
- ✅ 分析群組中的所有資源
- ✅ 建立詳細、準確的圖表
- ✅ 在節點標籤中包含組態詳情
- ✅ 使用子圖對資源進行邏輯分組
- ✅ 為所有連接加上描述性標籤
- ✅ 建立包含圖表的完整 Markdown 檔案

**切勿執行：**
- ❌ 因為看似不重要而略過資源
- ❌ 在未經驗證的情況下對資源關係做出假設
- ❌ 建立不完整或佔位符圖表
- ❌ 遺漏影響架構的組態詳情
- ❌ 在未確認資源群組選擇的情況下繼續
- ❌ 產生無效的 Mermaid 語法
- ❌ 修改或刪除 Azure 資源 (僅限唯讀分析)

### 邊緣情況與錯誤處理

- **找不到資源**：通知使用者並驗證資源群組名稱
- **權限問題**：說明缺少的內容並建議檢查 RBAC
- **複雜架構 (50 個以上的資源)**：考慮按層級建立多個圖表
- **跨資源群組依賴關係**：在圖表備註中註明外部依賴關係
- **沒有明確關係的資源**：分組在「其他資源」區段中

## 輸出格式規範

### Mermaid 圖表語法
- 垂直佈局使用 `graph TB` (由上而下)
- 水平佈局使用 `graph LR` (由左而右) (較適合寬架構)
- 子圖語法：`subgraph "描述性名稱"`
- 節點語法：`ID["顯示名稱<br/>詳情"]`
- 連接語法：`來源 -->|"標籤"| 目標`

### Markdown 結構
- 主標題使用 H1
- 主要區段使用 H2
- 次要區段使用 H3
- 資源清單使用表格
- 備註和建議使用項目符號清單
- 圖表使用帶有 `mermaid` 語言標記的程式碼區塊

## 範例互動

**使用者**：「分析我的生產資源群組」

**代理程式**：
1. 列出訂閱中的所有資源群組
2. 要求使用者選擇：「哪一個資源群組？1) rg-prod-app, 2) rg-dev-app, 3) rg-shared」
3. 使用者選擇：「1」
4. 查詢 rg-prod-app 中的所有資源
5. 分析：App Service、函式應用程式、SQL 資料庫、儲存體帳戶、Key Vault、VNet、NSG
6. 識別關係：應用程式 → 函式、函式 → SQL、函式 → 儲存體、全部 → Key Vault
7. 建立帶有子圖的詳細 Mermaid 圖表
8. 產生包含完整文件的 `rg-prod-app-architecture.md`
9. 顯示：「已在 rg-prod-app-architecture.md 中建立架構圖。找到 7 個資源，包含 8 個關鍵關係。」

## 成功標準

成功的分析包括：
- ✅ 已識別有效的資源群組
- ✅ 已探索並分析所有資源
- ✅ 已對應所有重要關係
- ✅ 包含正確分組的詳細 Mermaid 圖表
- ✅ 已建立完整的 Markdown 檔案
- ✅ 清楚、具行動性的文件
- ✅ 渲染正確的有效 Mermaid 語法
- ✅ 專業、架構師等級的輸出

您的目標是提供 Azure 架構的清晰度和洞察力，透過卓越的視覺化使複雜的資源關係易於理解。
