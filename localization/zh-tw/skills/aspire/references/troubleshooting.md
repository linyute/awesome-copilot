# 疑難排解 — 診斷與常見問題

---

## 診斷代碼 (Diagnostic Codes)

Aspire 會針對常見問題發送診斷代碼。這些代碼會出現在建置警告/錯誤和 IDE 診斷中。

### 標準診斷

| 代碼 | 嚴重性 | 說明 |
| ------------- | -------- | ---------------------------------------------------------- |
| **ASPIRE001** | 警告 | 資源名稱包含無效字元 |
| **ASPIRE002** | 警告 | 偵測到重複的資源名稱 |
| **ASPIRE003** | 錯誤 | 遺漏必要的套件參考 |
| **ASPIRE004** | 警告 | 已過時的 API 用法 |
| **ASPIRE005** | 錯誤 | 無效的端點組態 |
| **ASPIRE006** | 警告 | 未針對使用 `.WaitFor()` 的資源設定健康檢查 |
| **ASPIRE007** | 警告 | 未指定容器映像標籤 (將使用 `latest`) |
| **ASPIRE008** | 錯誤 | 在資源圖表中偵測到循環相依性 |

### 實驗性診斷 (ASPIREHOSTINGX\*)

這些代碼表示使用了實驗性/預覽版 API。如果您刻意使用實驗性功能，可能需要 `#pragma warning disable` 或 `<NoWarn>`：

| 代碼 | 區域 |
| ------------------------- | -------------------------------- |
| ASPIRE_HOSTINGX_0001–0005 | 實驗性裝載 API |
| ASPIRE_HOSTINGX_0006–0010 | 實驗性整合 API |
| ASPIRE_HOSTINGX_0011–0015 | 實驗性部署 API |
| ASPIRE_HOSTINGX_0016–0022 | 實驗性資源模型 API |

若要隱藏實驗性警告：

```xml
<!-- 在 .csproj 中 -->
<PropertyGroup>
  <NoWarn>$(NoWarn);ASPIRE_HOSTINGX_0001</NoWarn>
</PropertyGroup>
```

或逐行隱藏：

```csharp
#pragma warning disable ASPIRE_HOSTINGX_0001
var resource = builder.AddExperimentalResource("test");
#pragma warning restore ASPIRE_HOSTINGX_0001
```

---

## 常見問題與解決方案

### 容器執行階段

| 問題 | 解決方案 |
| --------------------------------- | ------------------------------------------------------------------------------------------------------ |
| 「無法連線到 Docker 常駐程式 (daemon)」 | 啟動 Docker Desktop / Podman / Rancher Desktop |
| 容器啟動失敗 | 檢查 `docker ps -a` 以獲取結束代碼；檢查儀表板主控台記錄 |
| 連接埠已被佔用 | 另一個程序正在使用該連接埠；Aspire 會自動分配，但 `targetPort` 在容器上必須是可用的 |
| 容器映像提取 (pull) 失敗 | 檢查網路連線能力；驗證映像名稱和標籤 |
| Linux 上的「權限遭拒 (Permission denied)」 | 將使用者新增至 `docker` 群組：`sudo usermod -aG docker $USER` |

### 服務探索

| 問題 | 解決方案 |
| ----------------------------- | ---------------------------------------------------------------------------- |
| 服務找不到相依項目 | 驗證 AppHost 中的 `.WithReference()`；檢查儀表板中的環境變數 |
| 連接字串為 Null | 參考資源名稱不符；檢查 `ConnectionStrings__<名稱>` |
| 服務 URL 中的連接埠錯誤 | 檢查 `targetPort` 與實際服務接聽連接埠 |
| 未設定環境變數 | 重新建構 AppHost；驗證資源名稱是否完全相符 |

### Python 工作負載

| 問題 | 解決方案 |
| --------------------------------- | --------------------------------------------------------------- |
| 「找不到 Python」 | 確保 Python 已加入 PATH；在 `AddPythonApp()` 中指定完整路徑 |
| 找不到 venv | 使用 `.WithVirtualEnvironment()` 或手動建立 venv |
| pip 套件安裝失敗 | 使用 `.WithPipPackages()` 或在 `aspire run` 之前於 venv 中安裝 |
| ModuleNotFoundError | venv 未啟動；`.WithVirtualEnvironment()` 會處理此問題 |
| Uvicorn 的「連接埠已被佔用」 | 檢查 `targetPort` — 可能有另一個執行個體正在執行 |

### JavaScript / TypeScript 工作負載

| 問題 | 解決方案 |
| ----------------------------- | ---------------------------------------------------------------- |
| 「找不到 node_modules」 | 使用 `.WithNpmPackageInstallation()` 自動安裝 |
| npm install 失敗 | 檢查 `package.json` 是否有效；檢查 npm 登錄連線能力 |
| Vite 開發伺服器無法啟動 | 驗證 `vite` 是否在 devDependencies 中；檢查 Vite 組態 |
| 連接埠不符 | 確保 `targetPort` 與您的 JS 框架組態中的連接埠相符 |
| TypeScript 編譯錯誤 | 這些錯誤發生在服務中，而非 Aspire — 請檢查服務記錄 |

### Go 工作負載

| 問題 | 解決方案 |
| -------------------------- | ---------------------------------------------------------- |
| 「找不到 go」 | 確保 Go 已安裝且已加入 PATH |
| 建置失敗 | 檢查工作目錄中是否存在 `go.mod` |
| 「目錄中沒有 Go 檔案」 | 驗證 `workingDir` 指向包含 `main.go` 的目錄 |

### Java 工作負載

| 問題 | 解決方案 |
| ------------------------ | ------------------------------------------------------- |
| 「找不到 java」 | 確保已安裝 JDK 且已設定 `JAVA_HOME` |
| Maven/Gradle 建置失敗 | 驗證建置檔案是否存在；檢查建置工具安裝情況 |
| Spring Boot 無法啟動 | 檢查 `application.properties`；驗證主要類別 |

### Rust 工作負載

| 問題 | 解決方案 |
| -------------------- | -------------------------------------------------------------------- |
| 「找不到 cargo」 | 透過 rustup 安裝 Rust |
| 建置耗時過長 | Rust 編譯時間正常為較長；使用 `.WithCargoBuild()` 進行預建置 |

### 健康檢查與啟動

| 問題 | 解決方案 |
| ---------------------------- | ------------------------------------------------------------------------------ |
| 資源卡在「啟動中 (Starting)」 | 健康檢查端點沒有回應；請檢查服務記錄 |
| `.WaitFor()` 逾時 | 增加逾時時間或修正健康檢查端點；預設為 30 秒 |
| 健康檢查始終失敗 | 驗證端點路徑 (預設為 `/health`)；檢查服務是否繫結至正確的連接埠 |
| 串聯啟動失敗 | 某個相依項目失敗；請先檢查根資源 |

### 儀表板

| 問題 | 解決方案 |
| ------------------------------------- | ------------------------------------------------------------------------- |
| 儀表板無法開啟 | 檢查終端機以獲取 URL；使用 `--dashboard-port` 使用固定連接埠 |
| 沒有出現記錄 | 服務可能未寫入 stdout/stderr；請檢查主控台輸出 |
| 非 .NET 服務沒有追蹤 | 在服務中設定 OpenTelemetry SDK；請參閱[儀表板](dashboard.md) |
| 追蹤未顯示跨服務呼叫 | 傳播追蹤內容標頭 (`traceparent`, `tracestate`) |

### 建置與組態

| 問題 | 解決方案 |
| ----------------------------------------- | ------------------------------------------------------------------- |
| `AddProject<T>()` 找不到專案 | 確保 `.csproj` 在解決方案中且已被 AppHost 參考 |
| 套件版本衝突 | 將所有 Aspire 套件固定在同一版本 |
| AppHost 無法建構 | 檢查專案中是否有 `Aspire.AppHost.Sdk`；執行 `dotnet restore` |
| `aspire run` 建置錯誤 | 先修正建置錯誤；`aspire run` 需要建置成功 |

### 部署

| 問題 | 解決方案 |
| ---------------------------------------- | -------------------------------------------------------------------- |
| `aspire publish` 失敗 | 檢查是否已安裝發佈器套件 (例如 `Aspire.Hosting.Docker`) |
| 產生的 Bicep 有錯誤 | 檢查是否有不受支援的資源組態 |
| 容器映像推送 (push) 失敗 | 驗證登錄認證和權限 |
| 部署中遺漏連接字串 | 檢查產生的 ConfigMaps/Secrets 是否與資源名稱相符 |

---

## 偵錯策略

### 1. 先檢查儀表板

儀表板會顯示資源狀態、記錄、追蹤和計量。遇到任何問題，請先從這裡開始。

### 2. 檢查環境變數

在儀表板中，點擊資源以查看所有插入的環境變數。驗證連接字串和服務 URL 是否正確。

### 3. 讀取主控台記錄

儀表板 → 主控台記錄 → 依失敗的資源進行篩選。原始的 stdout/stderr 通常包含根本原因。

### 4. 檢查 DAG

如果服務無法啟動，請檢查相依性順序。失敗的相依項目會阻塞所有下游資源。

### 5. 使用 MCP 進行 AI 輔助偵錯

如果已設定 MCP (請參閱 [MCP 伺服器](mcp-server.md))，請詢問您的 AI 助理：

- 「哪些資源失敗了？」
- 「顯示 [服務] 的記錄」
- 「哪些追蹤顯示錯誤？」

### 6. 隔離問題

在 AppHost 中註解掉其他資源，僅執行失敗的資源。這可以縮小問題範圍，確定是資源本身還是相依項目的問題。

---

## 獲取說明

| 管道 | URL |
| ----------------------- | ---------------------------------------------- |
| GitHub Issues (執行階段) | https://github.com/dotnet/aspire/issues |
| GitHub Issues (文件) | https://github.com/microsoft/aspire.dev/issues |
| Discord | https://aka.ms/aspire/discord |
| Stack Overflow | 標籤：`dotnet-aspire` |
| Reddit | https://www.reddit.com/r/aspiredotdev/ |
