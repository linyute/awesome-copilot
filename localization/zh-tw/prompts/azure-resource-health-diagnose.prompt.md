---
mode: 'agent'
description: '分析 Azure 資源健康狀態，診斷日誌與遙測問題，並針對發現的問題建立修復計畫。'
---

# Azure 資源健康診斷與問題分析

此工作流程會分析指定的 Azure 資源，評估其健康狀態，利用日誌與遙測資料診斷潛在問題，並針對發現的問題制定完整修復計畫。

## 先決條件
- 已設定並驗證 Azure MCP 伺服器
- 已指定目標 Azure 資源（名稱，選填資源群組/訂閱）
- 資源必須已部署且執行中才能產生日誌/遙測
- 優先使用 Azure MCP 工具（`azmcp-*`），如無則用 Azure CLI

## 工作流程步驟

### 步驟 1：取得 Azure 最佳實踐
**動作**：取得診斷與疑難排解最佳實踐
**工具**：Azure MCP 最佳實踐工具
**流程**：
1. **載入最佳實踐**：
   - 執行 Azure 最佳實踐工具取得診斷指引
   - 聚焦於健康監控、日誌分析與問題解決模式
   - 以這些實踐指引診斷方法與修復建議

### 步驟 2：資源發現與識別
**動作**：定位並識別目標 Azure 資源
**工具**：Azure MCP 工具 + Azure CLI 備用
**流程**：
1. **資源查找**：
   - 僅提供資源名稱時：用 `azmcp-subscription-list` 跨訂閱搜尋
   - 用 `az resource list --name <resource-name>` 找出符合資源
   - 若有多筆結果，請使用者指定訂閱/資源群組
   - 收集詳細資源資訊：
     - 資源類型與目前狀態
     - 位置、標籤與設定
     - 關聯服務與相依

2. **資源類型偵測**：
   - 辨識資源類型以決定診斷方法：
     - **Web Apps/Function Apps**：應用日誌、效能指標、相依追蹤
     - **虛擬機**：系統日誌、效能計數器、開機診斷
     - **Cosmos DB**：請求指標、限流、分割統計
     - **儲存體帳戶**：存取日誌、效能指標、可用性
     - **SQL 資料庫**：查詢效能、連線日誌、資源使用率
     - **Application Insights**：應用遙測、例外、相依
     - **Key Vault**：存取日誌、憑證狀態、機密使用
     - **Service Bus**：訊息指標、死信佇列、吞吐量

### 步驟 3：健康狀態評估
**動作**：評估目前資源健康與可用性
**工具**：Azure MCP 監控工具 + Azure CLI
**流程**：
1. **基本健康檢查**：
   - 檢查資源佈建狀態與運作狀態
   - 驗證服務可用性與回應性
   - 檢視近期部署或設定變更
   - 評估目前資源使用率（CPU、記憶體、儲存等）

2. **服務特定健康指標**：
   - **Web Apps**：HTTP 回應碼、回應時間、正常運作率
   - **資料庫**：連線成功率、查詢效能、死結
   - **儲存體**：可用性百分比、請求成功率、延遲
   - **虛擬機**：開機診斷、客體 OS 指標、網路連線
   - **Functions**：執行成功率、執行時間、錯誤頻率

### 步驟 4：日誌與遙測分析
**動作**：分析日誌與遙測資料以找出問題與模式
**工具**：Azure MCP 監控工具（Log Analytics 查詢）
**流程**：
1. **尋找監控來源**：
   - 用 `azmcp-monitor-workspace-list` 找 Log Analytics 工作區
   - 找出資源關聯的 Application Insights 實例
   - 用 `azmcp-monitor-table-list` 找相關日誌表格

2. **執行診斷查詢**：
   用 `azmcp-monitor-log-query` 依資源類型執行 KQL 查詢：

   **一般錯誤分析**：
   ```kql
   // 近期錯誤與例外
   union isfuzzy=true 
       AzureDiagnostics,
       AppServiceHTTPLogs,
       AppServiceAppLogs,
       AzureActivity
   | where TimeGenerated > ago(24h)
   | where Level == "Error" or ResultType != "Success"
   | summarize ErrorCount=count() by Resource, ResultType, bin(TimeGenerated, 1h)
   | order by TimeGenerated desc
   ```

   **效能分析**：
   ```kql
   // 效能下降模式
   Perf
   | where TimeGenerated > ago(7d)
   | where ObjectName == "Processor" and CounterName == "% Processor Time"
   | summarize avg(CounterValue) by Computer, bin(TimeGenerated, 1h)
   | where avg_CounterValue > 80
   ```

   **應用特定查詢**：
   ```kql
   // Application Insights - 失敗請求
   requests
   | where timestamp > ago(24h)
   | where success == false
   | summarize FailureCount=count() by resultCode, bin(timestamp, 1h)
   | order by timestamp desc
   
   // 資料庫 - 連線失敗
   AzureDiagnostics
   | where ResourceProvider == "MICROSOFT.SQL"
   | where Category == "SQLSecurityAuditEvents"
   | where action_name_s == "CONNECTION_FAILED"
   | summarize ConnectionFailures=count() by bin(TimeGenerated, 1h)
   ```

3. **模式辨識**：
   - 辨識重複錯誤模式或異常
   - 將錯誤與部署時間或設定變更關聯
   - 分析效能趨勢與下降模式
   - 檢查相依失敗或外部服務問題

### 步驟 5：問題分類與根因分析
**動作**：分類發現的問題並找出根本原因
**流程**：
1. **問題分類**：
   - **重大**：服務不可用、資料遺失、資安漏洞
   - **高**：效能下降、間歇性失敗、高錯誤率
   - **中**：警告、次佳設定、輕微效能問題
   - **低**：資訊性警示、最佳化機會

2. **根因分析**：
   - **設定問題**：設定錯誤、相依缺失
   - **資源限制**：CPU/記憶體/磁碟不足、限流
   - **網路問題**：連線障礙、DNS 解析、防火牆規則
   - **應用問題**：程式錯誤、記憶體洩漏、查詢效率低
   - **外部相依**：第三方服務失效、API 限制
   - **資安問題**：驗證失敗、憑證過期

3. **影響評估**：
   - 判斷業務影響與受影響用戶/系統
   - 評估資料完整性與資安影響
   - 評估復原時效目標與優先順序

### 步驟 6：建立修復計畫
**動作**：制定完整修復計畫以解決發現問題
**流程**：
1. **立即行動**（重大問題）：
   - 緊急修復以恢復服務
   - 臨時因應措施降低影響
   - 複雜問題啟動升級程序

2. **短期修正**（高/中問題）：
   - 設定調整與資源擴充
   - 應用程式更新與修補
   - 監控與警示改善

3. **長期改善**（所有問題）：
   - 架構調整以提升韌性
   - 預防措施與監控強化
   - 文件與流程改善

4. **實作步驟**：
   - 依優先順序列出具體 Azure CLI 指令
   - 測試與驗證程序
   - 各項變更的回溯計畫
   - 監控以驗證問題解決

### 步驟 7：使用者確認與報告產生
**動作**：呈現發現結果並取得修復同意
**流程**：
1. **顯示健康評估摘要**：
   ```
   🏥 Azure 資源健康評估
   
   📊 資源概覽：
   • 資源：[名稱]（[類型]）
   • 狀態：[健康/警告/重大]
   • 位置：[區域]
   • 最後分析時間：[時間戳記]
   
   🚨 發現問題：
   • 重大：X 項需立即處理
   • 高：Y 項影響效能/可靠性  
   • 中：Z 項最佳化
   • 低：N 項資訊性項目
   
   🔍 主要問題：
   1. [問題類型]：[說明] - 影響：[高/中/低]
   2. [問題類型]：[說明] - 影響：[高/中/低]
   3. [問題類型]：[說明] - 影響：[高/中/低]
   
   🛠️ 修復計畫：
   • 立即行動：X 項
   • 短期修正：Y 項  
   • 長期改善：Z 項
   • 預估解決時程：[時程]
   
   ❓ 是否繼續詳細修復計畫？(y/n)
   ```

2. **產生詳細報告**：
   ```markdown
   # Azure 資源健康報告：[資源名稱]
   
   **產生時間**：[時間戳記]  
   **資源**：[完整資源 ID]  
   **整體健康**：[狀態（含顏色指示）]
   
   ## 🔍 執行摘要
   [健康狀態與主要發現簡述]
   
   ## 📊 健康指標
   - **可用性**：過去 24 小時 X%
   - **效能**：[平均回應時間/吞吐量]
   - **錯誤率**：過去 24 小時 X%
   - **資源使用率**：[CPU/記憶體/儲存百分比]
   
   ## 🚨 發現問題
   
   ### 重大問題
   - **[問題 1]**：[說明]
     - **根因**：[分析]
     - **影響**：[業務影響]
     - **立即行動**：[必要步驟]
   
   ### 高優先問題  
   - **[問題 2]**：[說明]
     - **根因**：[分析]
     - **影響**：[效能/可靠性影響]
     - **建議修正**：[解決步驟]
   
   ## 🛠️ 修復計畫
   
   ### 階段 1：立即行動（0-2 小時）
   ```bash
   # 關鍵修復以恢復服務
   [Azure CLI 指令與說明]
   ```
   
   ### 階段 2：短期修正（2-24 小時）
   ```bash
   # 效能與可靠性改善
   [Azure CLI 指令與說明]
   ```
   
   ### 階段 3：長期改善（1-4 週）
   ```bash
   # 架構與預防措施
   [Azure CLI 指令與設定變更]
   ```
   
   ## 📈 監控建議
   - **建議設定警示**：[警示清單]
   - **建議建立儀表板**：[監控儀表板建議]
   - **定期健康檢查**：[建議頻率與範圍]
   
   ## ✅ 驗證步驟
   - [ ] 透過日誌驗證問題解決
   - [ ] 確認效能改善
   - [ ] 測試應用功能
   - [ ] 更新監控與警示
   - [ ] 記錄經驗教訓
   
   ## 📝 預防措施
   - [預防類似問題的建議]
   - [流程改善]
   - [監控強化]
   ```

## 錯誤處理
- **找不到資源**：提供資源名稱/位置指定指引
- **驗證問題**：指引使用者設定 Azure 驗證
- **權限不足**：列出存取資源所需 RBAC 角色
- **無日誌可用**：建議啟用診斷設定並等待資料產生
- **查詢逾時**：分段分析較短時間區間
- **服務特定問題**：提供一般健康評估並註明限制

## 成功標準
- ✅ 正確評估資源健康狀態
- ✅ 發現並分類所有重大問題
- ✅ 完成主要問題根因分析
- ✅ 提供具體可執行修復計畫
- ✅ 包含監控與預防建議
- ✅ 依業務影響明確排序問題
- ✅ 實作步驟含驗證與回溯程序
