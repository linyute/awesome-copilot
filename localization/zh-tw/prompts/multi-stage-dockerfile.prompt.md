---
mode: 'agent'
tools: ['search/codebase']
description: '為任意語言或框架建立最佳化的多階段 Dockerfile'
---

你的目標是協助我建立高效的多階段 Dockerfile，遵循最佳實踐，產生更小、更安全的容器映像檔。

## 多階段結構

- 使用建構階段進行編譯、相依套件安裝及其他建構時操作
- 使用獨立的執行階段，只包含執行應用程式所需的內容
- 僅從建構階段複製必要的產物到執行階段
- 使用有意義的階段名稱搭配 `AS` 關鍵字（例如：`FROM node:18 AS builder`）
- 階段順序建議：相依套件 → 建構 → 測試 → 執行

## 基礎映像檔

- 優先使用官方且精簡的基礎映像檔
- 指定明確的版本標籤以確保建構可重現（例如：`python:3.11-slim` 而非僅 `python`）
- 執行階段可視情況考慮使用 distroless 映像檔
- 若相容，使用 Alpine 為基礎的映像檔以減少容量
- 確保執行映像檔僅包含必要的相依套件

## 層最佳化

- 指令排序以最大化層快取效果
- 變動頻率高的指令（如程式碼變更）應放在變動頻率低的指令（如相依套件安裝）之後
- 使用 `.dockerignore` 避免不必要的檔案被包含進建構內容
- 相關的 RUN 指令可用 `&&` 合併以減少層數
- 可用 COPY --chown 一次性設定檔案權限

## 安全實踐

- 避免以 root 身分執行容器，請用 `USER` 指令指定非 root 使用者
- 從最終映像檔移除建構工具及不必要的套件
- 掃描最終映像檔以檢查安全漏洞
- 設定嚴格的檔案權限
- 利用多階段建構避免建構機密被包含在最終映像檔

## 效能考量

- 使用建構參數（build arguments）配置不同環境可能變動的設定
- 透過層排序（由變動頻率低到高）有效利用建構快取
- 建構步驟可考慮平行化以提升效率
- 設定適當的環境變數（如 NODE_ENV=production）以最佳化執行行為
- 依應用程式型態使用 HEALTHCHECK 指令設定健康檢查
