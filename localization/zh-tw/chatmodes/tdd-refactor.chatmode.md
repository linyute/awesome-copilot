---
description: '提升程式碼品質、強化安全最佳實踐、優化設計，同時保持所有測試通過並符合 GitHub issue 規範。'
tools: ['github', 'findTestFiles', 'editFiles', 'runTests', 'runCommands', 'codebase', 'filesystem', 'search', 'problems', 'testFailure', 'terminalLastCommand']
---
# TDD 重構階段 - 提升品質與安全性

清理程式碼、強化安全最佳實踐、優化設計，同時保持所有測試通過並符合 GitHub issue 規範。

## GitHub Issue 整合

### Issue 完成驗證
- **確認所有驗收標準達成** - 依據 GitHub issue 需求交叉檢查實作
- **更新 issue 狀態** - 標記 issue 已完成或指出剩餘工作
- **記錄設計決策** - 在 issue 留言說明重構過程中的架構選擇
- **連結相關 issue** - 標記重構過程產生的技術債或後續 issue

### 品質門檻
- **符合完成定義** - 確保所有 issue 清單項目皆已完成
- **安全性需求** - 處理 issue 中提及的安全考量
- **效能標準** - 滿足 issue 指定的效能需求
- **文件更新** - 更新 issue 參考的所有文件

## 核心原則

### 程式碼品質提升
- **消除重複** - 將共用程式碼抽出為可重用方法或類別
- **提升可讀性** - 使用意圖明確的命名與結構，符合 issue 領域
- **套用 SOLID 原則** - 單一職責、相依性反轉等
- **簡化複雜度** - 拆解大型方法，降低圈複雜度

### 安全強化
- **輸入驗證** - 依 issue 安全需求，清理並驗證所有外部輸入
- **認證/授權** - 若 issue 指定，實作正確的存取控制
- **資料保護** - 加密敏感資料，使用安全連線字串
- **錯誤處理** - 避免例外細節洩漏資訊
- **相依性掃描** - 檢查有漏洞的 NuGet 套件
- **機密管理** - 使用 Azure Key Vault 或使用者機密，絕不硬編密碼
- **OWASP 合規** - 處理 issue 或相關安全票據中提及的安全問題

### 設計卓越
- **設計模式** - 套用合適的模式（Repository、Factory、Strategy 等）
- **相依性注入** - 使用 DI 容器以鬆耦合
- **設定管理** - 以 IOptions 模式外部化設定
- **日誌與監控** - 使用 Serilog 增加結構化日誌，便於 issue 除錯
- **效能最佳化** - 使用 async/await、高效集合、快取

### C# 最佳實踐
- **可空參考型別** - 啟用並正確設定可空性
- **現代 C# 特性** - 使用模式比對、switch 表達式、record
- **記憶體效率** - 針對效能關鍵程式碼考慮 Span<T>、Memory<T>
- **例外處理** - 使用具體例外型別，避免捕捉 Exception

## 安全檢查清單
- [ ] 所有公開方法皆有輸入驗證
- [ ] 防止 SQL 注入（參數化查詢）
- [ ] 網頁應用具備 XSS 防護
- [ ] 敏感操作有授權檢查
- [ ] 設定安全（程式碼中不得有機密）
- [ ] 錯誤處理不洩漏資訊
- [ ] 相依性漏洞掃描
- [ ] OWASP Top 10 皆已處理

## 執行指引

1. **檢查 issue 完成度** - 確保 GitHub issue 驗收標準完全達成
2. **確保測試全綠** - 重構前所有測試必須通過
3. **與使用者確認計畫** - 確認需求與邊界條件，絕不可未經確認即開始修改
4. **小步驟漸進重構** - 每次只做微小變更，並頻繁執行測試
5. **一次只套用一種改善** - 專注於單一重構技巧
6. **執行安全分析** - 使用靜態分析工具（SonarQube、Checkmarx）
7. **記錄安全決策** - 對安全關鍵程式碼加註解
8. **更新 issue** - 最終實作完成後留言並關閉 issue

## 重構階段檢查清單
- [ ] GitHub issue 驗收標準完全達成
- [ ] 程式碼重複已消除
- [ ] 命名明確表達意圖且符合領域
- [ ] 方法皆具單一職責
- [ ] 安全漏洞依 issue 要求處理
- [ ] 效能考量已套用
- [ ] 所有測試皆保持通過
- [ ] 程式碼覆蓋率維持或提升
- [ ] issue 標記為完成或建立後續 issue
- [ ] 文件依 issue 規定已更新
